# Лучшие туры

Приложение по бронированию туров. Каждый пользователь может войдя в приложение забронировать и купить тур. 

В зависимости от того, какой пользователь авторизируется на сайте (простой пользователь, модератор или администратор) для пользователя октрываются разные возможности на сайте.
К примеру простой пользователь может только просматривать свой профиль, открывать и покупать туры. Модератор может всё тоже что и простой пользователь, но и дополнительно создавать, редактировать или удалять туры. Администратор помимо всего что может модератор, может ещё назначить роли. 

Стэк технологий:
Язык программирования и фрэймворки: JavaScript, Express.
- Базы данных: MongoDB
- Шаблонизаторы: Pug, Handlebars.
- Различные библиотеки: Passport.js, Crypto, Nodemailer, Stripe, Multer, JWT.
- API документация: Postman, Swagger.

### Данные
Чтобы войти на сайт простым пользователем введите следующие данные:
- Почта: vladislav.zelenskiy@gmail.com
- Пароль: 12345678

Чтобы войти на сайт администратором введите следующие данные:
- Почта: alexander.hmarenko@gmail.com
- Пароль: 12345678

## Оглавление
- [Лучшие туры](#лучшие-туры)
    - [Данные](#данные)
  - [Оглавление](#оглавление)
  - [Запуск и развёртывание проекта](#запуск-и-развёртывание-проекта)
    - [Развёртывание руками на своей хост машине](#развёртывание-руками-на-своей-хост-машине)
    - [Развёртывание через образ Docker](#развёртывание-через-образ-docker)
    - [Запуск через Heroku](#запуск-через-heroku)
  - [Архитектура приложения](#архитектура-приложения)
  - [Уровень доступа исходя из роли пользователя](#уровень-доступа-исходя-из-роли-пользователя)
  - [Главная страница с турами](#главная-страница-с-турами)
  - [Бронирование и оплата](#бронирование-и-оплата)

## Запуск и развёртывание проекта

### Развёртывание руками на своей хост машине
Разворачивание может быть достаточно затратным, поскольку приложение содержит большое количество переменных окружений, поэтому проще развернуть через Docker образ, поэтому этот путь только для самых отчаянных.

Чтобы развернуть на своей хост машине проект необходимо зарегистрироватся на следующих сервисах:
- SENDGRID
- MongoDB
- Stripe

После того как вы зарегистрировались на данных сервисах необходимо скачать последний релиз проекта, который находится в репозитории проекта.
После чего в корне проекта необходимо создать файл `.env`, в который указать следующие переменные:

### Развёртывание через образ Docker

### Запуск через Heroku

Перейдите по ссылке в Environments или же по этой ссылке: [Лучшие туры](https://tours-nodejs-app.herokuapp.com/)

Чтобы полностью протестировать приложение необходимо авторизироватся, чтобы авторизироватся выберите необходимый тип аккаунта: [Данные](#данные)

## Архитектура приложения

Монолитная архитектура API с отдельным роутом, по которому странички, обработанные шаблонизатором показывают визуальную реализацию приложения. Также по отдельному маршруту стоит swagger документация:
- `localhost:4000/api/v1/` - базовый путь для доступа к API. 
  - в соответствии с типом сущности туров - `tours/`, пользователей - `users/`, бронирований `bookings/` или комментариев `reviews/` предоставляется свой путь. 
- `localhost:4000/` - путь визуализации страничек.
- `localhost:4000/api/v1/api-docs` - путь размещения swagger документации к API

## Уровень доступа исходя из роли пользователя

Вход в учётную запись происходит непосредственно через страничку логирования:

[![image.png](https://i.postimg.cc/WzM4YXSY/image.png)](https://postimg.cc/tn4yYdKF)

**Используйте [данные](#данные) указанные вначале README.md**

В зависимости от аккаунта определяется разная роль пользователя.
Страница профиля простого пользователя:

[![image.png](https://i.postimg.cc/FRTpdV0q/image.png)](https://postimg.cc/FdJ3wcWg)

Страница профиля администратора:

[![image.png](https://i.postimg.cc/3w7FtcBV/image.png)](https://postimg.cc/fV2dL51f)

Благодаря промежуточному обработчику:
```
exports.restrictTo = (...roles) => {
  return (req, res, next) => {
    if (!roles.includes(req.user.role)) {
      return next(
        new AppError(
          'Вы не владеете достаточными правами для совершения подобных действий',
          403
        )
      );
    }

    next();
  };
};
```

Таким образом перечень ролей `roles` определяет доступ к определённому роуту. В нужном машруте просто указыватеся промежуточный обработчик:

```
bookingRouter.use(restrictTo('admin', 'lead-guide'));
```

Чтобы ограничить досттуп ко всем машрутам, которые идут ниже по коду только для пользователей, у которых роль = `admin` или `lead-guide` 

## Главная страница с турами

После авторизации пользователь переадресовывается на главную страницу:

[![image.png](https://i.postimg.cc/Y9yXyBb8/image.png)](https://postimg.cc/cgwMr2q8)

При этом открытие каждого из тура допустимо и для не зарегестрируемых пользователей. Если не зарегистрируемый пользователь выбирает определённый тур, то чтобы этот тур забронировать пользовать должен сперва авторизироватся.

[![image.png](https://i.postimg.cc/pdc73jdD/image.png)](https://postimg.cc/d7d4yLr1)

## Бронирование и оплата

В конце каждого тура есть возможность забронировать тур:

[![image.png](https://i.postimg.cc/RhHTs63V/image.png)](https://postimg.cc/m1TMhrN0)

При бронировании тура приложение перенаправляет пользователя на страничку оплаты:

[![image.png](https://i.postimg.cc/76p32HBv/image.png)](https://postimg.cc/N9k2hcqb)

После чего данный тур попадает в список покупок пользователя.